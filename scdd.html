<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sri Chowdeshwari Devi Devastanam, Proddatur</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 3. Configure Tailwind & Base Styles -->
    <style>
        /* Base font settings */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Aspect ratio helper for iframes */
        .aspect-w-16 {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
        }
        .aspect-w-16 iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        /* Toast Animation */
        #toast {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Traditional color palette
                        saffron: {
                            DEFAULT: '#F4C430',
                            '100': '#FEF9E7',
                            '600': '#DAA520',
                            '700': '#B8860B',
                        },
                        maroon: {
                            DEFAULT: '#800000',
                            '800': '#800000',
                            '900': '#600000',
                        },
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
</head>
<body class="bg-saffron-100 text-gray-800 antialiased">

    <!-- ===== HEADER ===== -->
    <header class="bg-maroon-800 text-white shadow-lg sticky top-0 z-40">
        <nav class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-center py-4">
                <!-- Temple Name & Location -->
                <div class="cursor-pointer" onclick="window.location.reload()">
                    <h1 class="text-2xl sm:text-3xl font-bold text-center sm:text-left">
                        Sri Chowdeshwari Devi Devastanam
                    </h1>
                    <p class="text-sm text-amber-100 text-center sm:text-left">
                        Chowdeshwari Nagar, Subbareddy Kottalu, Proddatur, Kadapa District
                    </p>
                </div>
                <!-- Admin Login Button -->
                <div class="mt-3 sm:mt-0">
                    <button id="admin-login-button" class="bg-maroon-800 text-maroon-900 font-bold py-2 px-4 rounded-lg shadow hover:bg-saffron-700 transition-colors duration-200">
                        ðŸ›•
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 min-h-screen">

        <!-- ========================== -->
        <!-- VIEW 1: LIST VIEW CONTAINER -->
        <!-- ========================== -->
        <div id="list-view-container">
            
            <!-- ===== ADMIN PANEL (Hidden by default) ===== -->
            <section id="admin-panel" class="hidden bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="form-heading" class="text-2xl font-bold text-maroon-900">Admin: Add New Activity</h2>
                    <span id="edit-mode-badge" class="hidden px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">Editing Mode</span>
                </div>
                
                <form id="activity-form" class="space-y-4">
                    <!-- Activity Title -->
                    <div>
                        <label for="activity-title" class="block text-sm font-medium text-gray-700">Activity Title</label>
                        <input type="text" id="activity-title" name="activity-title" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-maroon-800 focus:border-maroon-800 sm:text-sm">
                    </div>
                    <!-- Activity Description -->
                    <div>
                        <label for="activity-description" class="block text-sm font-medium text-gray-700">Activity Description</label>
                        <textarea id="activity-description" name="activity-description" rows="3" required
                                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-maroon-800 focus:border-maroon-800 sm:text-sm"></textarea>
                    </div>
                    
                    <!-- Media Source Selection (File or URL) -->
                    <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Media Source (Photo or Video)</label>
                        
                        <!-- Option 1: File Upload -->
                        <div class="mb-3">
                            <label for="activity-media-file" class="block text-xs text-gray-500 mb-1 uppercase tracking-wide">Option 1: Upload File</label>
                            <input type="file" id="activity-media-file" accept="image/*,video/mp4,video/webm"
                                   class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-saffron-600 file:text-maroon-900 hover:file:bg-saffron-700 cursor-pointer">
                            <p class="text-xs text-gray-400 mt-1">Images are auto-resized. Videos must be under 1MB (use URL for larger videos).</p>
                        </div>

                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">OR</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>

                        <!-- Option 2: URL -->
                        <div>
                            <label for="activity-media-url" class="block text-xs text-gray-500 mb-1 uppercase tracking-wide">Option 2: Paste URL (Best for YouTube/Vimeo)</label>
                            <input type="url" id="activity-media-url" name="activity-media-url"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-maroon-800 focus:border-maroon-800 sm:text-sm"
                                   placeholder="https://youtu.be/... or https://example.com/image.jpg">
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex items-center space-x-3">
                        <button type="submit" id="submit-activity-btn" class="w-full sm:w-auto inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-maroon-800 hover:bg-maroon-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-maroon-700 transition-colors">
                            Add Activity
                        </button>
                        <button type="button" id="cancel-edit-btn" class="hidden w-full sm:w-auto inline-flex justify-center py-2 px-6 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-maroon-500 transition-colors">
                            Cancel Edit
                        </button>
                    </div>
                </form>
            </section>

            <!-- ===== PUBLIC FEED: MINIMIZED LIST ===== -->
            <section id="public-feed">
                <h2 class="text-3xl font-bold text-maroon-900 mb-6 pl-2 border-l-4 border-saffron-600">Recent Activities</h2>
                
                <!-- Feed Status Message -->
                <p id="feed-status" class="text-gray-600 text-lg text-center">Loading activities...</p>
                
                <!-- Activities List -->
                <div id="activities-feed" class="space-y-3">
                    <!-- Cards will be inserted here -->
                </div>
            </section>
        </div>

        <!-- ============================ -->
        <!-- VIEW 2: DETAIL VIEW CONTAINER -->
        <!-- ============================ -->
        <div id="detail-view-container" class="hidden">
            <!-- Back Button -->
            <button id="back-to-list-btn" class="mb-6 flex items-center text-maroon-900 font-semibold hover:text-saffron-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back to Activities
            </button>

            <!-- Detail Content -->
            <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-amber-200">
                <div id="detail-media-container" class="w-full bg-black">
                    <!-- Media injected here -->
                </div>
                <div class="p-6 sm:p-8">
                    <h1 id="detail-title" class="text-2xl sm:text-4xl font-bold text-maroon-900 mb-3"></h1>
                    <p id="detail-date" class="text-gray-500 mb-6 flex items-center font-medium"></p>
                    
                    <div class="prose prose-lg max-w-none text-gray-800">
                        <p id="detail-description" class="whitespace-pre-wrap leading-relaxed"></p>
                    </div>

                    <!-- Admin Actions (Only shown if logged in) -->
                    <div id="detail-admin-actions" class="mt-8 pt-6 border-t border-gray-100 flex justify-end space-x-4 hidden">
                        <button id="detail-edit-btn" class="flex items-center px-4 py-2 bg-blue-50 text-blue-700 rounded-md hover:bg-blue-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            Edit Activity
                        </button>
                        <button id="detail-delete-btn" class="flex items-center px-4 py-2 bg-red-50 text-red-700 rounded-md hover:bg-red-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            Delete Activity
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- ===== ADMIN LOGIN MODAL ===== -->
    <div id="password-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold text-maroon-900 mb-4">Admin Login</h3>
            <p id="login-error" class="text-red-600 text-sm mb-3 hidden">Incorrect password. Please try again.</p>
            <div class="space-y-4">
                <label for="admin-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="admin-password" name="admin-password"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-maroon-800 focus:border-maroon-800 sm:text-sm">
                <div class="flex justify-end space-x-3">
                    <button id="login-cancel-button" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button id="login-submit-button" type="button" class="py-2 px-4 bg-maroon-800 text-white rounded-md hover:bg-maroon-900 transition-colors">
                        Login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== DELETE CONFIRMATION MODAL ===== -->
    <div id="delete-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-semibold text-maroon-900 mb-4">Confirm Delete</h3>
            <p class="text-gray-700 mb-6">Are you sure you want to delete this activity? This cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Cancel</button>
                <button id="confirm-delete-btn" class="py-2 px-4 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Delete</button>
            </div>
        </div>
    </div>

    <!-- ===== NOTIFICATION TOAST ===== -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 opacity-0 transform translate-y-2 transition-all duration-300">
        <span id="toast-message">Notification</span>
    </div>

    <!-- ===== FOOTER ===== -->
    <footer class="text-center py-6 mt-12 border-t border-amber-200">
        <p class="text-gray-600">&copy; <span id="current-year"></span> Sri Chowdeshwari Devi Devastanam. All rights reserved.</p>
    </footer>

    <!-- ===== JAVASCRIPT / FIREBASE ===== -->
    <script type="module">
        // 4. Import Firebase Services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc,
            addDoc,
            updateDoc,
            deleteDoc,
            query, 
            orderBy, 
            onSnapshot, 
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const listViewContainer = document.getElementById('list-view-container');
        const detailViewContainer = document.getElementById('detail-view-container');
        const backToListBtn = document.getElementById('back-to-list-btn');

        // Detail View Elements
        const detailTitle = document.getElementById('detail-title');
        const detailDate = document.getElementById('detail-date');
        const detailDesc = document.getElementById('detail-description');
        const detailMedia = document.getElementById('detail-media-container');
        const detailAdminActions = document.getElementById('detail-admin-actions');
        const detailEditBtn = document.getElementById('detail-edit-btn');
        const detailDeleteBtn = document.getElementById('detail-delete-btn');

        // Common Elements
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminPanel = document.getElementById('admin-panel');
        const formHeading = document.getElementById('form-heading');
        const editModeBadge = document.getElementById('edit-mode-badge');
        
        const activityForm = document.getElementById('activity-form');
        const titleInput = document.getElementById('activity-title');
        const descInput = document.getElementById('activity-description');
        const fileInput = document.getElementById('activity-media-file');
        const urlInput = document.getElementById('activity-media-url');
        const submitActivityBtn = document.getElementById('submit-activity-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        
        const activitiesFeed = document.getElementById('activities-feed');
        const feedStatus = document.getElementById('feed-status');
        
        // Modals
        const passwordModal = document.getElementById('password-modal');
        const adminPasswordInput = document.getElementById('admin-password');
        const loginSubmitButton = document.getElementById('login-submit-button');
        const loginCancelButton = document.getElementById('login-cancel-button');
        const loginError = document.getElementById('login-error');

        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        // --- Firebase Config ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- App State ---
        let db;
        let auth;
        let userId;
        let isAdmin = false; 
        let editingId = null; 
        let editingData = null; 
        let pendingDeleteId = null;
        let currentDetailId = null; // Track which activity is open
        
        const ACTIVITIES_COLLECTION = `/artifacts/${appId}/public/data/activities`;

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        listenForActivities();
                    } else {
                        userId = null;
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                feedStatus.textContent = "Error: Could not connect to the database.";
            }
        }

        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${isError ? 'bg-red-800' : 'bg-gray-800'} text-white`;
            toast.classList.remove('hidden', 'opacity-0', 'translate-y-2');
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function listenForActivities() {
            if (!db) return; 

            const q = query(collection(db, ACTIVITIES_COLLECTION), orderBy("timestamp", "desc"));

            onSnapshot(q, (querySnapshot) => {
                activitiesFeed.innerHTML = ''; 
                
                if (querySnapshot.empty) {
                    feedStatus.textContent = "No recent activities have been posted yet.";
                    feedStatus.classList.remove('hidden');
                } else {
                    feedStatus.classList.add('hidden');
                    querySnapshot.forEach((doc) => {
                        const activity = doc.data();
                        const card = createMinimalActivityCard(activity, doc.id);
                        activitiesFeed.appendChild(card);
                    });
                }
            }, (error) => {
                console.error("Error listening to activities: ", error);
                feedStatus.textContent = "Error loading activities.";
                feedStatus.classList.remove('hidden');
            });
        }

        // Helpers for Embeds
        function getYouTubeEmbed(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length == 11) {
                return `https://www.youtube.com/embed/${match[2]}`;
            }
            return null;
        }

        function getVimeoEmbed(url) {
            const regExp = /vimeo\.com\/(\d+)/;
            const match = url.match(regExp);
            if (match) {
                return `https://player.vimeo.com/video/${match[1]}`;
            }
            return null;
        }

        function getMediaHtml(mediaUrl, title) {
             const placeholderImg = "https://placehold.co/600x400/F4C430/800000?text=No+Media";
             const finalUrl = mediaUrl || placeholderImg;

             const youtubeEmbed = getYouTubeEmbed(finalUrl);
             const vimeoEmbed = getVimeoEmbed(finalUrl);

             if (youtubeEmbed) {
                return `<div class="aspect-w-16 h-64 sm:h-96 bg-black">
                        <iframe src="${youtubeEmbed}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full"></iframe>
                    </div>`;
            } else if (vimeoEmbed) {
                return `<div class="aspect-w-16 h-64 sm:h-96 bg-black">
                        <iframe src="${vimeoEmbed}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen class="w-full h-full"></iframe>
                    </div>`;
            } else if (finalUrl.startsWith('data:video') || finalUrl.endsWith('.mp4') || finalUrl.endsWith('.webm')) {
                 return `<video controls class="w-full max-h-[500px] bg-black mx-auto">
                        <source src="${finalUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>`;
            } else {
                return `<img src="${finalUrl}" 
                     alt="${title || 'Activity Image'}" 
                     class="w-full h-64 sm:h-96 object-cover"
                     onerror="this.src='${placeholderImg}'; this.onerror=null;">`;
            }
        }

        /**
         * Creates a MINIMAL list item (Title + Timestamp).
         */
        function createMinimalActivityCard(activity, docId) {
            const card = document.createElement('div');
            // Styling for clickable list item
            card.className = "bg-white rounded-lg border border-gray-200 p-4 flex justify-between items-center cursor-pointer hover:bg-amber-50 hover:border-amber-300 hover:shadow-md transition-all duration-200 group";

            // Format timestamp
            let dateString = "Just now";
            if (activity.timestamp && activity.timestamp.toDate) {
                dateString = activity.timestamp.toDate().toLocaleString('en-IN', {
                    dateStyle: 'medium',
                    timeStyle: 'short'
                });
            }

            card.innerHTML = `
                <div class="flex-grow">
                    <h3 class="text-lg font-semibold text-gray-800 group-hover:text-maroon-900 transition-colors">${activity.title || 'Untitled Activity'}</h3>
                    <p class="text-xs text-gray-500 font-medium mt-1 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        ${dateString}
                    </p>
                </div>
                <div class="ml-4 text-gray-400 group-hover:text-saffron-600 group-hover:translate-x-1 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </div>
            `;

            // On click, open detail view
            card.onclick = () => openDetailView(activity, docId);

            return card;
        }

        /**
         * Opens the Detail View with full activity info.
         */
        function openDetailView(activity, docId) {
            currentDetailId = docId;
            
            // 1. Populate Content
            detailTitle.textContent = activity.title || 'Untitled';
            detailDesc.textContent = activity.description || '';
            
            // Date
            let dateString = "Just now";
            if (activity.timestamp && activity.timestamp.toDate) {
                dateString = activity.timestamp.toDate().toLocaleString('en-IN', {
                    dateStyle: 'full',
                    timeStyle: 'short'
                });
            }
            detailDate.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> ${dateString}`;

            // Media
            detailMedia.innerHTML = getMediaHtml(activity.imageUrl, activity.title);

            // 2. Handle Admin Actions Visibility
            if (isAdmin) {
                detailAdminActions.classList.remove('hidden');
                // Attach handlers securely with closure
                detailEditBtn.onclick = () => {
                    hideDetailView(); // Go back to list/form
                    prepareEditActivity(docId, activity);
                };
                detailDeleteBtn.onclick = () => {
                    pendingDeleteId = docId;
                    deleteModal.classList.remove('hidden');
                };
            } else {
                detailAdminActions.classList.add('hidden');
            }

            // 3. Switch Views
            listViewContainer.classList.add('hidden');
            detailViewContainer.classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function hideDetailView() {
            detailViewContainer.classList.add('hidden');
            listViewContainer.classList.remove('hidden');
            currentDetailId = null;
            window.scrollTo(0, 0);
        }

        // --- Logic for Editing/Deleting ---

        function prepareEditActivity(id, data) {
            editingId = id;
            editingData = data;
            
            adminPanel.classList.remove('hidden');
            adminPanel.scrollIntoView({ behavior: 'smooth' });

            titleInput.value = data.title || '';
            descInput.value = data.description || '';
            
            if (data.imageUrl && data.imageUrl.startsWith('http')) {
                urlInput.value = data.imageUrl;
            } else {
                urlInput.value = '';
            }

            formHeading.textContent = "Edit Activity";
            editModeBadge.classList.remove('hidden');
            submitActivityBtn.textContent = "Update Activity";
            cancelEditBtn.classList.remove('hidden');
            
            adminPanel.classList.add('ring-2', 'ring-maroon-800');
            setTimeout(() => adminPanel.classList.remove('ring-2', 'ring-maroon-800'), 1000);
        }

        function cancelEditMode() {
            editingId = null;
            editingData = null;
            activityForm.reset();
            
            formHeading.textContent = "Admin: Add New Activity";
            editModeBadge.classList.add('hidden');
            submitActivityBtn.textContent = "Add Activity";
            cancelEditBtn.classList.add('hidden');
        }

        function processMediaFile(file) {
            return new Promise((resolve, reject) => {
                if (file.size > 2 * 1024 * 1024) { 
                     reject("File is too large! Please use a file smaller than 2MB.");
                     return;
                }
                if (file.type.startsWith('video/') && file.size > 950 * 1024) {
                    reject("Video file is too large for the database (Limit: 1MB). Please upload to YouTube and use the URL instead.");
                    return;
                }

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    if (file.type.startsWith('image/')) {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800;
                            const scaleSize = MAX_WIDTH / img.width;
                            const newWidth = (img.width > MAX_WIDTH) ? MAX_WIDTH : img.width;
                            const newHeight = (img.width > MAX_WIDTH) ? (img.height * scaleSize) : img.height;
                            canvas.width = newWidth;
                            canvas.height = newHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, newWidth, newHeight);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                        img.onerror = (err) => reject(err);
                    } else {
                        resolve(event.target.result);
                    }
                };
                reader.onerror = (err) => reject(err);
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const title = titleInput.value;
            const description = descInput.value;
            let mediaUrl = urlInput.value;

            if (!title || !description) {
                showToast("Please fill out title and description", true);
                return;
            }

            submitActivityBtn.disabled = true;
            const originalBtnText = submitActivityBtn.textContent;
            submitActivityBtn.textContent = "Processing...";

            try {
                if (fileInput.files.length > 0) {
                    submitActivityBtn.textContent = "Processing Media...";
                    mediaUrl = await processMediaFile(fileInput.files[0]);
                } else if (!mediaUrl && editingId && editingData) {
                    mediaUrl = editingData.imageUrl;
                } else if (!mediaUrl) {
                    showToast("Please provide an image or video", true);
                    throw new Error("No media provided");
                }

                submitActivityBtn.textContent = "Saving...";

                if (editingId) {
                    await updateDoc(doc(db, ACTIVITIES_COLLECTION, editingId), {
                        title: title,
                        description: description,
                        imageUrl: mediaUrl
                    });
                    showToast("Activity updated successfully!");
                    cancelEditMode();
                } else {
                    await addDoc(collection(db, ACTIVITIES_COLLECTION), {
                        title: title,
                        description: description,
                        imageUrl: mediaUrl, 
                        timestamp: serverTimestamp() 
                    });
                    activityForm.reset();
                    fileInput.value = '';
                    showToast("Activity posted successfully!");
                }

            } catch (error) {
                console.error("Error saving document: ", error);
                if (error.message !== "No media provided") {
                   showToast("Error: " + error.message, true);
                }
            } finally {
                submitActivityBtn.disabled = false;
                submitActivityBtn.textContent = originalBtnText;
            }
        }
        
        function handleAdminLogin() {
            const password = adminPasswordInput.value;
            if (password === 'SRKottalu+2024') { //adminpassword
                isAdmin = true; 
                adminPanel.classList.remove('hidden');
                passwordModal.classList.add('hidden');
                adminPasswordInput.value = '';
                loginError.classList.add('hidden');
            } else {
                loginError.classList.remove('hidden');
            }
        }

        // --- Event Listeners ---

        // Detail View Back Button
        backToListBtn.addEventListener('click', hideDetailView);

        // Modal: Login
        adminLoginButton.addEventListener('click', () => {
            passwordModal.classList.remove('hidden');
            adminPasswordInput.focus();
        });
        loginCancelButton.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
            adminPasswordInput.value = '';
            loginError.classList.add('hidden');
        });
        loginSubmitButton.addEventListener('click', handleAdminLogin);
        adminPasswordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') handleAdminLogin();
        });

        // Modal: Delete
        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            pendingDeleteId = null;
        });
        confirmDeleteBtn.addEventListener('click', async () => {
            if (pendingDeleteId) {
                try {
                    await deleteDoc(doc(db, ACTIVITIES_COLLECTION, pendingDeleteId));
                    showToast("Activity deleted successfully");
                    deleteModal.classList.add('hidden');
                    hideDetailView(); // Go back to list after delete
                    pendingDeleteId = null;
                } catch (error) {
                    console.error("Error deleting:", error);
                    showToast("Error deleting activity", true);
                }
            }
        });

        activityForm.addEventListener('submit', handleFormSubmit);
        cancelEditBtn.addEventListener('click', cancelEditMode);

        document.getElementById('current-year').textContent = new Date().getFullYear();

        initializeFirebase();

    </script>
</body>
</html>
